name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  # ============================================
  # Deploy Frontend to Vercel
  # ============================================
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    # Vercel handles deployment automatically via GitHub integration
    # This job is here for visibility and can be extended for other platforms
    steps:
      - name: Frontend deployment
        run: echo "Frontend deploys automatically via Vercel GitHub integration"

  # ============================================
  # Deploy Backend to Fly.io
  # ============================================
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: []  # Can add test job as dependency

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: |
          cd backend
          flyctl deploy --remote-only -c ../infra/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # ============================================
  # Deploy AI Worker to Railway
  # ============================================
  deploy-ai-worker:
    name: Deploy AI Worker
    runs-on: ubuntu-latest
    # Railway handles deployment automatically via GitHub integration
    steps:
      - name: AI Worker deployment
        run: echo "AI Worker deploys automatically via Railway GitHub integration"

  # ============================================
  # Run Database Migrations
  # ============================================
  run-migrations:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: [deploy-backend]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install migrate
        run: |
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          migrate -path backend/db/migrations -database "$DATABASE_URL" up

  # ============================================
  # Notify on completion
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, deploy-ai-worker, run-migrations]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Deployment completed!"
          # Add Slack/Discord notification here if needed
